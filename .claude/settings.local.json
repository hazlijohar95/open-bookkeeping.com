{
  "permissions": {
    "allow": [
      "Bash(DATABASE_URL=\"postgresql://postgres.kzapllpundevktoeeead:Xe0154810!!!@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres\" npx tsx -e:*)",
      "Bash(DATABASE_URL=\"postgresql://postgres.kzapllpundevktoeeead:Xe0154810!!!@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres\" npx tsx:*)",
      "WebFetch(domain:www.troublefreeai.com)",
      "Bash(yarn lint:*)",
      "Bash(npx eslint:*)",
      "Bash(timeout 120 yarn check-types:*)",
      "Bash(perl:*)",
      "Bash(for icon in CheckCircle2Icon ChevronRightIcon ChevronDownIcon ChevronUpIcon ChevronLeftIcon ClockIcon CurrencyDollarIcon FileTextIcon Loader2Icon PlayIcon SaveIcon StopCircleIcon XCircleIcon AlertCircleIcon SendIcon UserIcon UsersIcon CalendarIcon MailIcon SearchIcon MoreHorizontalIcon MoreVerticalIcon ArrowRightIcon CheckCircleIcon Trash2Icon)",
      "Bash(done)",
      "Bash(git checkout:*)",
      "Bash(for file in \"./providers/auth-provider.tsx\" \"./routes/create-invoice/helpers/invoice-image-selector-sheet.tsx\" \"./routes/create-quotation/helpers/quotation-image-selector-sheet.tsx\" \"./routes/create-credit-note/helpers/credit-note-image-selector-sheet.tsx\" \"./routes/create-debit-note/helpers/debit-note-image-selector-sheet.tsx\")",
      "Bash(do perl -pi -e 's/import type \\{ UserIcon \\}/import type { User }/g' \"$file\")",
      "Bash(npm run lint:*)",
      "Bash(git -C /Applications/Apps-Hazli/e-invoicing/invoicely-v2 status --short)",
      "Bash(git -C /Applications/Apps-Hazli/e-invoicing/invoicely-v2 diff --stat)",
      "Bash(git -C /Applications/Apps-Hazli/e-invoicing/invoicely-v2 diff)",
      "Bash(node -e:*)",
      "Bash(find:*)",
      "Bash(yarn add:*)",
      "Bash(yarn check-types:*)",
      "Bash(npx tsc:*)",
      "Bash(yarn tsc:*)",
      "Bash(yarn turbo run check-types:*)",
      "Bash(npx vue-tsc:*)",
      "Bash(pkill:*)",
      "Bash(yarn dev)",
      "Bash(cat package.json)",
      "Bash(echo:*)",
      "WebFetch(domain:github.com)",
      "Bash(ls:*)",
      "WebFetch(domain:x.com)",
      "WebSearch",
      "WebFetch(domain:vite-pwa-org.netlify.app)",
      "Skill(frontend-design:frontend-design)",
      "Bash(yarn build:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(cat:*)",
      "Bash(NODE_ENV=production npx vite:*)",
      "Bash(grep:*)",
      "Bash(VITE_API_URL=\"\" yarn build:*)",
      "Bash(curl:*)",
      "Bash(wc:*)",
      "Bash(yarn db:generate)",
      "Bash(yarn db:migrate:*)",
      "Bash(timeout 60 npx tsc:*)",
      "Bash(yarn test:run:*)",
      "WebFetch(domain:monk.com)",
      "Bash(timeout 60 yarn check-types:*)",
      "Bash(xargs basename:*)",
      "Bash(yarn turbo run lint:*)",
      "Bash(timeout 120 npx tsc:*)",
      "WebFetch(domain:supabase.com)",
      "Bash(DATABASE_URL=\"postgresql://postgres.kzapllpundevktoeeead:Xe0154810!!!@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres\" npx tsx -e '\nconst postgres = require(\"\"postgres\"\");\n\nasync function fix() {\n  const sql = postgres(process.env.DATABASE_URL);\n  \n  try {\n    console.log(\"\"=== Checking invoices columns ===\"\");\n    const cols = await sql`SELECT column_name FROM information_schema.columns WHERE table_name = ${\"\"invoices\"\"}`;\n    const hasCol = cols.some(c => c.column_name === \"\"invoice_number\"\");\n    console.log(\"\"invoice_number exists:\"\", hasCol);\n    \n    if (hasCol === false) {\n      console.log(\"\"Adding invoice_number column...\"\");\n      await sql`ALTER TABLE invoices ADD COLUMN invoice_number varchar(50)`;\n      console.log(\"\"Done\"\");\n    }\n    \n    console.log(\"\"\\n=== Adding Invoice Unique Constraint ===\"\");\n    try {\n      await sql`ALTER TABLE invoices ADD CONSTRAINT invoices_user_invoice_number_unique UNIQUE (user_id, invoice_number)`;\n      console.log(\"\"Constraint added\"\");\n    } catch (e) {\n      console.log(e.message.includes(\"\"already exists\"\") ? \"\"Already exists\"\" : e.message);\n    }\n    \n    console.log(\"\"\\n=== Enabling pgcrypto ===\"\");\n    await sql`CREATE EXTENSION IF NOT EXISTS pgcrypto`;\n    console.log(\"\"Done\"\");\n    \n    console.log(\"\"\\n=== Adding encrypted columns ===\"\");\n    await sql`ALTER TABLE vendors ADD COLUMN IF NOT EXISTS bank_account_number_encrypted BYTEA`;\n    await sql`ALTER TABLE employees ADD COLUMN IF NOT EXISTS ic_number_encrypted BYTEA`;\n    await sql`ALTER TABLE employees ADD COLUMN IF NOT EXISTS passport_number_encrypted BYTEA`;\n    await sql`ALTER TABLE employees ADD COLUMN IF NOT EXISTS bank_account_number_encrypted BYTEA`;\n    await sql`ALTER TABLE employees ADD COLUMN IF NOT EXISTS tax_number_encrypted BYTEA`;\n    await sql`ALTER TABLE pay_slips ADD COLUMN IF NOT EXISTS ic_number_encrypted BYTEA`;\n    await sql`ALTER TABLE pay_slips ADD COLUMN IF NOT EXISTS bank_account_number_encrypted BYTEA`;\n    console.log(\"\"All encrypted columns added\"\");\n    \n    console.log(\"\"\\n=== Creating encryption functions ===\"\");\n    await sql`\n      CREATE OR REPLACE FUNCTION encrypt_pii(plaintext TEXT, encryption_key TEXT)\n      RETURNS BYTEA LANGUAGE plpgsql SECURITY DEFINER AS $$\n      BEGIN\n        IF plaintext IS NULL OR plaintext = $e$ $e$ THEN RETURN NULL; END IF;\n        RETURN pgp_sym_encrypt(plaintext, encryption_key, $e$cipher-algo=aes256$e$);\n      END;\n      $$\n    `;\n    \n    await sql`\n      CREATE OR REPLACE FUNCTION decrypt_pii(ciphertext BYTEA, encryption_key TEXT)\n      RETURNS TEXT LANGUAGE plpgsql SECURITY DEFINER AS $$\n      BEGIN\n        IF ciphertext IS NULL THEN RETURN NULL; END IF;\n        RETURN pgp_sym_decrypt(ciphertext, encryption_key);\n      EXCEPTION WHEN OTHERS THEN RETURN NULL;\n      END;\n      $$\n    `;\n    console.log(\"\"Functions created\"\");\n    \n    console.log(\"\"\\n=== Verification ===\"\");\n    const chk = await sql`SELECT conname FROM pg_constraint WHERE conrelid = ${\"\"journal_entries\"\"}::regclass AND contype = ${\"\"c\"\"}`;\n    console.log(\"\"Journal CHECK constraints:\"\", chk.length);\n    \n    const unq = await sql`SELECT conname FROM pg_constraint WHERE conrelid = ${\"\"invoices\"\"}::regclass AND contype = ${\"\"u\"\"}`;\n    console.log(\"\"Invoice UNIQUE constraints:\"\", unq.length);\n    \n    const enc = await sql`SELECT COUNT(*) as c FROM information_schema.columns WHERE column_name LIKE ${\"\"%\"\" + \"\"_encrypted\"\"}`;\n    console.log(\"\"Encrypted columns:\"\", enc[0].c);\n    \n    console.log(\"\"\\nâœ… All database fixes applied\"\");\n    \n  } catch (e) {\n    console.error(\"\"Error:\"\", e.message);\n  } finally {\n    await sql.end();\n  }\n}\n\nfix();\n')"
    ],
    "deny": [],
    "ask": []
  }
}
